<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Esercizi Interattivi - Ratei e Risconti</title>
  <style>
    body { font-family:'Segoe UI', Tahoma, sans-serif; line-height:1.6; color:#2c3e50; background:#f8f9fa; margin:0; padding:20px;}
    .container { max-width:1200px; margin:auto; background:#fff; padding:20px; box-shadow:0 0 20px rgba(0,0,0,0.1);}
    h1 { text-align:center; color:#2980b9; margin-bottom:20px;}
    .instructions { background:#eaf6ff; border-left:5px solid #2980b9; padding:15px; margin-bottom:20px; border-radius:5px;}
    .options { margin-bottom:20px; }
    .options label { margin-right:15px; }
    button { padding:10px 20px; margin:10px 0; border:none; border-radius:5px; background:#2980b9; color:#fff; cursor:pointer; font-size:1em;}
    button:hover { background:#1f669e;}
    .example-box { background:#f0f8ff; border-left:5px solid #3498db; padding:20px; margin:20px 0; border-radius:5px;}
    .timeline-wrapper { margin:25px 0;}
    .timeline-bar { display:flex; height:40px; border-radius:10px; overflow:hidden; background:#ecf0f1;}
    .segment { display:flex; align-items:center; justify-content:center; font-size:0.8em; font-weight:bold; color:#fff;}
    .competenza { background:#27ae60;}
    .non-competenza { background:#c0392b;}
    .date-labels { display:flex; justify-content:space-between; margin-top:5px; font-size:0.85em; font-weight:bold;}
    .accounting-entry { background:#f8f9fa; border:2px solid #dee2e6; border-radius:8px; padding:20px; margin:15px 0; font-family:'Courier New', monospace;}
    .accounting-entry .date { font-weight:bold; color:#2980b9; margin-bottom:10px; font-size:1.1em; text-align:center; border-bottom:2px solid #dee2e6; padding-bottom:5px;}
    .accounting-entry table { width:100%; border-collapse:collapse; margin-top:10px;}
    .accounting-entry th { background:#e9ecef; padding:8px; border:1px solid #dee2e6; text-align:center;}
    .accounting-entry td { padding:8px; border:1px solid #dee2e6;}
    .dare { color:#c0392b; font-weight:bold; text-align:right;}
    .avere { color:#27ae60; font-weight:bold; text-align:right;}
    .mastrini-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;}
    .mastrino { border:2px solid #bdc3c7; border-radius:10px; overflow:hidden;}
    .mastrino .title { text-align:center; background:#ecf0f1; padding:8px; font-weight:bold;}
    .mastrino table { width:100%; border-collapse:collapse;}
    .mastrino th, .mastrino td { border:1px solid #dee2e6; padding:6px; text-align:center;}
    .saldo { background:#f6f6f6; font-weight:bold;}
    #soluzione { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Esercizi Interattivi - Ratei e Risconti</h1>

    <div class="instructions">
      <p>Seleziona uno o più argomenti e clicca su <b>Genera esercizio</b>. Non viene indicata la natura dell’operazione: devi individuarla tu. Poi clicca <b>Mostra soluzione</b> per verificare timeline, calcoli, scritture contabili e mastrini.</p>
    </div>

    <div class="options">
      <label><input type="checkbox" value="rateo-attivo"> RATEI ATTIVI</label>
      <label><input type="checkbox" value="rateo-passivo"> RATEI PASSIVI</label>
      <label><input type="checkbox" value="risconto-attivo"> RISCONTI ATTIVI</label>
      <label><input type="checkbox" value="risconto-passivo"> RISCONTI PASSIVI</label>
    </div>

    <button onclick="generaEsercizio()">Genera esercizio</button>
    <div id="esercizio"></div>
    <button id="btnSoluzione" onclick="mostraSoluzione()" style="display:none;">Mostra soluzione</button>
    <div id="soluzione"></div>
  </div>

<script>
/* ---------- Utility ---------- */
function round2(v){ return Math.round(v * 100) / 100; }
function formatEuro(v){ return v.toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2}); }
function diffGiorni(d1,d2){ return Math.floor((d2-d1)/(1000*60*60*24)); }
function randomBetween(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pickRandom(a){ return a[Math.floor(Math.random()*a.length)]; }

/* Stato */
let esercizioCorrente=null;

/* ---------- Genera esercizio ---------- */
function generaEsercizio(){
  const selezioni=Array.from(document.querySelectorAll(".options input:checked")).map(i=>i.value);
  if(selezioni.length===0){alert("Seleziona almeno un argomento!");return;}
  const scelta=pickRandom(selezioni);

  let testo="";

  // RATEO ATTIVO
  if(scelta==="rateo-attivo"){
    const cap=randomBetween(50000,100000);
    const tasso=round2(Math.random()*0.03+0.02);
    const dataInizio=new Date(2022,randomBetween(8,9),randomBetween(1,28)); // set-ott
    const dataFine=new Date(2023,dataInizio.getMonth(),dataInizio.getDate());

    const testi=[
      `La società vanta un credito per un titolo di €${formatEuro(cap)} che produce interessi al ${(tasso*100).toFixed(2)}% annuo. Gli interessi maturano dal ${dataInizio.toLocaleDateString()} (T) e saranno percepiti il ${dataFine.toLocaleDateString()} (T+1).`,
      `Un titolo del valore nominale €${formatEuro(cap)} genera un rendimento annuo del ${(tasso*100).toFixed(2)}%. Gli interessi decorreranno dal ${dataInizio.toLocaleDateString()} (T) e verranno incassati alla scadenza del ${dataFine.toLocaleDateString()} (T+1).`,
      `La società detiene un titolo (valore €${formatEuro(cap)}) con tasso annuo ${(tasso*100).toFixed(2)}%. Gli interessi maturano dal ${dataInizio.toLocaleDateString()} (T) al ${dataFine.toLocaleDateString()} (T+1).`
    ];

    testo=pickRandom(testi);
    esercizioCorrente={tipo:"rateo-attivo",cap,tasso,dataInizio,dataFine};
  }

  // RATEO PASSIVO
  if(scelta==="rateo-passivo"){
    const cap=randomBetween(100000,200000);
    const tasso=round2(Math.random()*0.03+0.03);
    const dataInizio=new Date(2022,randomBetween(9,11),randomBetween(1,28)); // ott-dic
    const dataFine=new Date(2023,dataInizio.getMonth(),dataInizio.getDate());

    const testi=[
      `In data ${dataInizio.toLocaleDateString()} (T) la società ottiene un finanziamento di €${formatEuro(cap)} al ${(tasso*100).toFixed(2)}% annuo. Gli interessi saranno corrisposti il ${dataFine.toLocaleDateString()} (T+1).`,
      `La società accende un mutuo di €${formatEuro(cap)} il ${dataInizio.toLocaleDateString()} (T), con tasso annuo del ${(tasso*100).toFixed(2)}%. Il pagamento degli interessi avverrà il ${dataFine.toLocaleDateString()} (T+1).`,
      `Il ${dataInizio.toLocaleDateString()} (T) viene stipulato un prestito di €${formatEuro(cap)} al ${(tasso*100).toFixed(2)}% annuo; gli interessi maturati verranno pagati alla scadenza del ${dataFine.toLocaleDateString()} (T+1).`
    ];

    testo=pickRandom(testi);
    esercizioCorrente={tipo:"rateo-passivo",cap,tasso,dataInizio,dataFine};
  }

  // RISCONTO ATTIVO
  if(scelta==="risconto-attivo"){
    const importo=randomBetween(2000,5000);
    const dataInizio=new Date(2022,randomBetween(9,11),randomBetween(1,28)); // ott-dic
    const dataFine=new Date(2023,dataInizio.getMonth(),dataInizio.getDate()-1);

    const testi=[
      `In data ${dataInizio.toLocaleDateString()} (T) la società paga €${formatEuro(importo)} per un servizio valido fino al ${dataFine.toLocaleDateString()} (T+1).`,
      `Il ${dataInizio.toLocaleDateString()} (T) viene versato un premio di €${formatEuro(importo)} per un periodo che termina il ${dataFine.toLocaleDateString()} (T+1).`,
      `La società sostiene un costo per servizi pari a €${formatEuro(importo)} il ${dataInizio.toLocaleDateString()} (T), valido fino al ${dataFine.toLocaleDateString()} (T+1).`
    ];

    testo=pickRandom(testi);
    esercizioCorrente={tipo:"risconto-attivo",importo,dataInizio,dataFine};
  }

  // RISCONTO PASSIVO
  if(scelta==="risconto-passivo"){
    const importo=randomBetween(4000,9000);
    const dataInizio=new Date(2022,randomBetween(10,11),randomBetween(1,28)); // nov-dic
    const dataFine=new Date(2023,dataInizio.getMonth()+5,dataInizio.getDate()-1);

    const testi=[
      `In data ${dataInizio.toLocaleDateString()} (T) la società incassa €${formatEuro(importo)} per un contratto valido fino al ${dataFine.toLocaleDateString()} (T+1).`,
      `Il ${dataInizio.toLocaleDateString()} (T) vengono riscossi €${formatEuro(importo)} per un affitto anticipato con scadenza al ${dataFine.toLocaleDateString()} (T+1).`,
      `La società riceve €${formatEuro(importo)} il ${dataInizio.toLocaleDateString()} (T) per un servizio da erogare fino al ${dataFine.toLocaleDateString()} (T+1).`
    ];

    testo=pickRandom(testi);
    esercizioCorrente={tipo:"risconto-passivo",importo,dataInizio,dataFine};
  }

  document.getElementById("esercizio").innerHTML=`<div class="example-box"><p>${testo}</p></div>`;
  document.getElementById("soluzione").style.display="none";
  document.getElementById("btnSoluzione").style.display="inline-block";
}

/* ---------- Mostra Soluzione ---------- */
function mostraSoluzione(){
  if(!esercizioCorrente) return;
  let sol=`<div class="example-box"><div class="title">Soluzione</div>`;

  // --- RATEO ATTIVO ---
  if(esercizioCorrente.tipo==="rateo-attivo"){
    const intAnnui=round2(esercizioCorrente.cap*esercizioCorrente.tasso);
    const giornaliero=round2(intAnnui/365);
    const giorniT=diffGiorni(esercizioCorrente.dataInizio,new Date(2022,11,31));
    const giorniT1=365-giorniT;
    const quotaT=round2(giorniT*giornaliero);
    const quotaT1=round2(intAnnui-quotaT);

    sol+=calcoliRatei(intAnnui,giornaliero,giorniT,quotaT,giorniT1,quotaT1);
    sol+=timeline(esercizioCorrente.dataInizio,esercizioCorrente.dataFine,giorniT,giorniT1);
    sol+=scrittura("31/12/2022 - Assestamento",[["Ratei attivi",quotaT,"D"],["Interessi attivi",quotaT,"A"]]);
    sol+=scrittura("01/01/2023 - Riapertura",[["Interessi attivi",quotaT,"D"],["Ratei attivi",quotaT,"A"]]);
    sol+=scrittura(`${esercizioCorrente.dataFine.toLocaleDateString()} - Incasso`,[["Banca c/c",intAnnui,"D"],["Interessi attivi",intAnnui,"A"]]);
    sol+=mastrini("RATEI ATTIVI (SP - Attivo)",[["31/12/2022",quotaT,"D"],["01/01/2023",quotaT,"A"]],"INTERESSI ATTIVI (CE)",[["31/12/2022",quotaT,"A"],["01/01/2023",quotaT,"D"],[esercizioCorrente.dataFine.toLocaleDateString(),intAnnui,"A"]]);
    sol+=riepilogo(quotaT,quotaT1);
  }

  // --- RATEO PASSIVO ---
  if(esercizioCorrente.tipo==="rateo-passivo"){
    const intAnnui=round2(esercizioCorrente.cap*esercizioCorrente.tasso);
    const giornaliero=round2(intAnnui/365);
    const giorniT=diffGiorni(esercizioCorrente.dataInizio,new Date(2022,11,31));
    const giorniT1=365-giorniT;
    const quotaT=round2(giorniT*giornaliero);
    const quotaT1=round2(intAnnui-quotaT);

    sol+=calcoliRatei(intAnnui,giornaliero,giorniT,quotaT,giorniT1,quotaT1);
    sol+=timeline(esercizioCorrente.dataInizio,esercizioCorrente.dataFine,giorniT,giorniT1);
    sol+=scrittura("31/12/2022 - Assestamento",[["Interessi passivi",quotaT,"D"],["Ratei passivi",quotaT,"A"]]);
    sol+=scrittura("01/01/2023 - Riapertura",[["Ratei passivi",quotaT,"D"],["Interessi passivi",quotaT,"A"]]);
    sol+=scrittura(`${esercizioCorrente.dataFine.toLocaleDateString()} - Pagamento`,[["Interessi passivi",round2(quotaT+quotaT1),"D"],["Banca c/c",round2(quotaT+quotaT1),"A"]]);
    sol+=mastrini("RATEI PASSIVI (SP - Passivo)",[["31/12/2022",quotaT,"A"],["01/01/2023",quotaT,"D"]],"INTERESSI PASSIVI (CE)",[["31/12/2022",quotaT,"D"],["01/01/2023",quotaT,"A"],[esercizioCorrente.dataFine.toLocaleDateString(),round2(quotaT+quotaT1),"D"]]);
    sol+=riepilogo(quotaT,quotaT1);
  }

  // --- RISCONTO ATTIVO ---
  if(esercizioCorrente.tipo==="risconto-attivo"){
    const giorniTot=diffGiorni(esercizioCorrente.dataInizio,esercizioCorrente.dataFine);
    const giornaliero=round2(esercizioCorrente.importo/giorniTot);
    const giorniT=diffGiorni(esercizioCorrente.dataInizio,new Date(2022,11,31));
    const giorniT1=giorniTot-giorniT;
    const quotaT=round2(giorniT*giornaliero);
    const quotaT1=round2(esercizioCorrente.importo-quotaT);

    sol+=calcoliRisconti(esercizioCorrente.importo,giornaliero,giorniTot,giorniT,quotaT,giorniT1,quotaT1);
    sol+=timeline(esercizioCorrente.dataInizio,esercizioCorrente.dataFine,giorniT,giorniT1);
    sol+=scrittura(`${esercizioCorrente.dataInizio.toLocaleDateString()} - Pagamento`,[["Costi per servizi",round2(esercizioCorrente.importo),"D"],["Banca c/c",round2(esercizioCorrente.importo),"A"]]);
    sol+=scrittura("31/12/2022 - Assestamento",[["Risconti attivi",quotaT1,"D"],["Costi per servizi",quotaT1,"A"]]);
    sol+=scrittura("01/01/2023 - Riapertura",[["Costi per servizi",quotaT1,"D"],["Risconti attivi",quotaT1,"A"]]);
    sol+=mastrini("RISCONTI ATTIVI (SP - Attivo)",[["31/12/2022",quotaT1,"D"],["01/01/2023",quotaT1,"A"]],"COSTI PER SERVIZI (CE)",[[esercizioCorrente.dataInizio.toLocaleDateString(),round2(esercizioCorrente.importo),"D"],["31/12/2022",quotaT1,"A"],["01/01/2023",quotaT1,"D"]]);
    sol+=riepilogo(quotaT,quotaT1);
  }

  // --- RISCONTO PASSIVO ---
  if(esercizioCorrente.tipo==="risconto-passivo"){
    const giorniTot=diffGiorni(esercizioCorrente.dataInizio,esercizioCorrente.dataFine);
    const giornaliero=round2(esercizioCorrente.importo/giorniTot);
    const giorniT=diffGiorni(esercizioCorrente.dataInizio,new Date(2022,11,31));
    const giorniT1=giorniTot-giorniT;
    const quotaT=round2(giorniT*giornaliero);
    const quotaT1=round2(esercizioCorrente.importo-quotaT);

    sol+=calcoliRisconti(esercizioCorrente.importo,giornaliero,giorniTot,giorniT,quotaT,giorniT1,quotaT1);
    sol+=timeline(esercizioCorrente.dataInizio,esercizioCorrente.dataFine,giorniT,giorniT1);
    sol+=scrittura(`${esercizioCorrente.dataInizio.toLocaleDateString()} - Incasso`,[["Banca c/c",round2(esercizioCorrente.importo),"D"],["Fitti attivi",round2(esercizioCorrente.importo),"A"]]);
    sol+=scrittura("31/12/2022 - Assestamento",[["Fitti attivi",quotaT1,"D"],["Risconti passivi",quotaT1,"A"]]);
    sol+=scrittura("01/01/2023 - Riapertura",[["Risconti passivi",quotaT1,"D"],["Fitti attivi",quotaT1,"A"]]);
    sol+=mastrini("RISCONTI PASSIVI (SP - Passivo)",[["31/12/2022",quotaT1,"A"],["01/01/2023",quotaT1,"D"]],"FITTI ATTIVI (CE)",[[esercizioCorrente.dataInizio.toLocaleDateString(),round2(esercizioCorrente.importo),"A"],["31/12/2022",quotaT1,"D"],["01/01/2023",quotaT1,"A"]]);
    sol+=riepilogo(quotaT,quotaT1);
  }

  sol+=`</div>`;
  document.getElementById("soluzione").innerHTML=sol;
  document.getElementById("soluzione").style.display="block";
}

/* ---------- Supporto ---------- */
function scrittura(titolo,righe){
  let rows="";
  righe.forEach(r=>{
    rows+=`<tr><td>${r[0]}</td>
      <td class="${r[2]==="D"?"dare":""}">${r[2]==="D"?"€"+formatEuro(r[1]):""}</td>
      <td class="${r[2]==="A"?"avere":""}">${r[2]==="A"?"€"+formatEuro(r[1]):""}</td></tr>`;
  });
  return `<div class="accounting-entry"><div class="date">${titolo}</div>
    <table><tr><th>Conto</th><th>Dare</th><th>Avere</th></tr>${rows}</table></div>`;
}

function mastrini(tit1,mov1,tit2,mov2){
  function tab(mov){
    let dareTot=0,avereTot=0;
    let rows=mov.map(r=>{
      if(r[2]==="D"){dareTot+=r[1]; return `<tr><td>${r[0]} €${formatEuro(r[1])}</td><td></td></tr>`;}
      else{avereTot+=r[1]; return `<tr><td></td><td>${r[0]} €${formatEuro(r[1])}</td></tr>`;}
    }).join("");
    let saldo="";
    if(dareTot>avereTot){saldo=`Saldo: €${formatEuro(dareTot-avereTot)} (Dare)`;}
    else if(avereTot>dareTot){saldo=`Saldo: €${formatEuro(avereTot-dareTot)} (Avere)`;}
    else{saldo="Saldo: 0";}
    return rows+`<tr class="saldo"><td colspan="2">${saldo}</td></tr>`;
  }
  return `<div class="mastrini-grid">
    <div class="mastrino"><div class="title">${tit1}</div><table><tr><th>DARE</th><th>AVERE</th></tr>${tab(mov1)}</table></div>
    <div class="mastrino"><div class="title">${tit2}</div><table><tr><th>DARE</th><th>AVERE</th></tr>${tab(mov2)}</table></div>
  </div>`;
}

function calcoliRatei(intAnnui,giornaliero,gT,quotaT,gT1,quotaT1){
  return `<p>Interessi annui = €${formatEuro(intAnnui)}.<br>
  Quota giornaliera = €${formatEuro(intAnnui)} ÷ 365 = €${formatEuro(giornaliero)}.<br>
  Quota T = ${gT} × €${formatEuro(giornaliero)} = €${formatEuro(quotaT)}.<br>
  Quota T+1 = ${gT1} × €${formatEuro(giornaliero)} = €${formatEuro(quotaT1)}.</p>`;
}

function calcoliRisconti(importo,giornaliero,gTot,gT,quotaT,gT1,quotaT1){
  return `<p>Importo totale = €${formatEuro(importo)}.<br>
  Quota giornaliera = €${formatEuro(importo)} ÷ ${gTot} = €${formatEuro(giornaliero)}.<br>
  Quota T = ${gT} × €${formatEuro(giornaliero)} = €${formatEuro(quotaT)}.<br>
  Quota T+1 = ${gT1} × €${formatEuro(giornaliero)} = €${formatEuro(quotaT1)}.</p>`;
}

function timeline(start,end,gT,gT1){
  return `<div class="timeline-wrapper">
    <div class="timeline-bar">
      <div class="segment competenza" style="flex:${gT};">T (${gT} gg)</div>
      <div class="segment non-competenza" style="flex:${gT1};">T+1 (${gT1} gg)</div>
    </div>
    <div class="date-labels"><span>${start.toLocaleDateString()}</span><span>${end.toLocaleDateString()}</span></div>
  </div>`;
}

function riepilogo(quotaT,quotaT1){
  return `<div class="example-box" style="background:#fdfdfd; border-left:5px solid #27ae60; margin-top:15px;">
    <p><b>Riepilogo competenze</b><br>
    Competenza T = €${formatEuro(quotaT)}<br>
    Competenza T+1 = €${formatEuro(quotaT1)}</p>
  </div>`;
}
</script>
</body>
</html>


